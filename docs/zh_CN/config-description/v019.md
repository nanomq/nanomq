# 0.19 åŠåç»­ç‰ˆæœ¬é…ç½®æ–‡ä»¶è¯´æ˜
æ­¤æ–‡æ¡£é€‚ç”¨äº 0.19 åŠåç»­ NanoMQ ç‰ˆæœ¬ã€‚


## é…ç½®æ–‡ä»¶è¯­æ³•
åœ¨é…ç½®æ–‡ä»¶ä¸­ï¼Œå€¼å¯ä»¥è¢«è®°ä¸ºç±»ä¼¼ JSON çš„å¯¹è±¡ï¼Œä¾‹å¦‚

```bash
log {
    dir = "/tmp"
    file = "nanomq.log"
}
```

å¦ä¸€ç§ç­‰ä»·çš„è¡¨ç¤ºæ–¹æ³•æ˜¯æ‰å¹³çš„ï¼Œä¾‹å¦‚

```bash
log.dir = "/tmp"
log.file = "nanomq.log"
```

è¿™ç§æ‰å¹³æ ¼å¼å‡ ä¹ä¸ NanoMQ çš„é…ç½®æ–‡ä»¶æ ¼å¼å‘åå…¼å®¹ï¼ˆæ‰€è°“çš„ 'cuttlefish' æ ¼å¼ï¼‰ã€‚

å®ƒå¹¶ä¸æ˜¯å®Œå…¨å…¼å®¹ï¼Œå› ä¸º HOCON ç»å¸¸è¦æ±‚å­—ç¬¦ä¸²ä¸¤ç«¯åŠ ä¸Šå¼•å·ã€‚
è€ŒcuttlefishæŠŠ`=`ç¬¦å³è¾¹çš„æ‰€æœ‰å­—ç¬¦éƒ½è§†ä¸ºå€¼ã€‚

ä¾‹å¦‚ï¼Œcuttlefishï¼š`websocket.bind = 0.0.0.0:8083/mqtt`ï¼ŒHOCONï¼š`websocket.bind = "0.0.0.0:8083/mqtt"`ã€‚
### é…ç½®é‡è½½è§„åˆ™
HOCONçš„å€¼æ˜¯åˆ†å±‚è¦†ç›–çš„ï¼Œæ™®éè§„åˆ™å¦‚ä¸‹ï¼š

- åœ¨åŒä¸€ä¸ªæ–‡ä»¶ä¸­ï¼Œåï¼ˆåœ¨æ–‡ä»¶åº•éƒ¨ï¼‰å®šä¹‰çš„å€¼ï¼Œè¦†ç›–å‰ï¼ˆåœ¨æ–‡ä»¶é¡¶éƒ¨ï¼‰åˆ°å€¼ã€‚
- å½“æŒ‰å±‚çº§è¦†ç›–æ—¶ï¼Œé«˜å±‚çº§çš„å€¼è¦†ç›–ä½å±‚çº§çš„å€¼ã€‚

æ¥ä¸‹æ¥çš„æ–‡æ¡£å°†è§£é‡Šæ›´è¯¦ç»†çš„è§„åˆ™ã€‚

åˆå¹¶è¦†ç›–è§„åˆ™ã€‚åœ¨å¦‚ä¸‹é…ç½®ä¸­ï¼Œæœ€åä¸€è¡Œçš„ `debug` å€¼ä¼šè¦†ç›–è¦†ç›–åŸå…ˆ `level` å­—æ®µçš„ `error` å€¼ï¼Œä½†æ˜¯ `to` å­—æ®µä¿æŒä¸å˜ã€‚
```bash
log {
    to=[file,console]
    level=error
}

## æ§åˆ¶å°æ—¥å¿—æ‰“å°å…ˆå®šä¹‰ä¸º `error` çº§åˆ«ï¼Œåè¢«è¦†å†™æˆ `debug` çº§åˆ«

log.level=debug
```



## å‚æ•°è¯´æ˜

### nanomq.conf
**ğŸ“¢æ³¨æ„ï¼š** ç°åœ¨ conf æ–‡ä»¶çš„é…ç½®æ–¹å¼å·²å–æ¶ˆ `enable`ï¼Œé»˜è®¤åªè¦é…ç½®å‡ºç°åœ¨é…ç½®æ–‡ä»¶ä¸­ï¼Œè¯¥é…ç½®å³ä¸º `enable`ã€‚

#### åŸºæœ¬é…ç½®å‚æ•°

å‚æ•°å                                | æ•°æ®ç±»å‹    | å‚æ•°è¯´æ˜
---------------------------------- | ------------- | -------------------------------
system.num_taskq_thread            | Long          | ä»»åŠ¡çº¿ç¨‹æ•°ã€‚
system.max_taskq_thread            | Long          | æœ€å¤§ä»»åŠ¡çº¿ç¨‹æ•°ã€‚
system.parallel                    | Long          | å¹¶è¡Œæ•°ã€‚
mqtt.max_packet_size               | Kbytes        | NanoMQ æ”¶å‘çš„æœ€å¤§åŒ…å¤§å° (Kbytes)
mqtt.max_mqueue_len                | Integer       | æœ€å¤§é˜Ÿåˆ—é•¿åº¦ã€‚
mqtt.retry_interval                | Duration      | QOS æ¶ˆæ¯å‘é€çš„é—´éš”æ—¶é—´ã€‚
mqtt.keepalive_multiplier          | Integer       | MQTT keepalive çš„é€€é¿æŒ‡æ•°
mqtt.property_size                 | Integer       | æœ€å¤§å±æ€§é•¿åº¦ã€‚
mqtt.max_inflight_window           | Integer       | æš‚æœªæ”¯æŒ
mqtt.max_awaiting_rel              | Duration      | æš‚æœªæ”¯æŒ
mqtt.await_rel_timeout             | Duration      | æš‚æœªæ”¯æŒ
listeners.tcp.bind                 | String        | ç›‘å¬ tcp urlã€‚
listeners.ssl.bind                 | String        | ç›‘å¬ tls urlã€‚ 
listeners.ssl.key                  | String        | TLS ç§é’¥æ•°æ®ã€‚
listeners.ssl.keypass              | String        | TLS ç§é’¥å¯†ç ã€‚
listeners.ssl.cert                 | String        | TLS Cert è¯ä¹¦æ•°æ®ã€‚
listeners.ssl.cacert               | String        | TLS CA è¯ä¹¦æ•°æ®ã€‚
listeners.ssl.verify_peer          | Boolean       | éªŒè¯å®¢æˆ·ç«¯è¯ä¹¦ã€‚
listeners.ssl.fail_if_no_peer_cert | Boolean       | æ‹’ç»æ— è¯ä¹¦è¿æ¥ï¼Œä¸ tls.verify_peer é…åˆä½¿ç”¨ã€‚
listeners.ws.bind                  | String        | Websocket ç›‘å¬ URLã€‚
listeners.wss.bind                 | String        | Websocket over TLS ç›‘å¬ URLã€‚
http_server.port                   | Integer       | Http æœåŠ¡ç«¯ç›‘å¬ç«¯å£ã€‚
http_server.limit_conn             | Integer       | Http æœåŠ¡å™¨å¤„ç†æŒ‡å®šæ•°é‡çš„æœªå®Œæˆè¯·æ±‚ã€‚
http_server.username               | String        | è®¿é—® Http æœåŠ¡ç”¨æˆ·åã€‚
http_server.password               | String        | è®¿é—® Http æœåŠ¡å¯†ç ã€‚
http_server.auth_type              | String        | Http é‰´æƒæ–¹å¼ã€‚ï¼ˆ_é»˜è®¤ basic_ï¼‰
http_server.jwt.public.keyfile     | String        | _JWT_ å…¬é’¥æ–‡ä»¶ .
log.to                             | Array[String] | æ—¥å¿—è¾“å‡ºç±»å‹æ•°ç»„ï¼Œä½¿ç”¨é€—å·`,`åˆ†éš”å¤šç§ç±»å‹<br>æ”¯æŒæ–‡ä»¶ï¼Œæ§åˆ¶å°ï¼Œ Syslog è¾“å‡ºï¼Œå¯¹åº”å‚æ•°:<br>file, console, syslog
log.level                          | String        | æ—¥å¿—ç­‰çº§ï¼š trace, debug, info, warn, error, fatal
log.dir                            | String        | æ—¥å¿—æ–‡ä»¶å­˜å‚¨è·¯å¾„ (è¾“å‡ºæ–‡ä»¶æ—¶ç”Ÿæ•ˆ)
log.file                           | String        | æ—¥å¿—æ–‡ä»¶å(è¾“å‡ºæ–‡ä»¶æ—¶ç”Ÿæ•ˆ)
log.rotation.size                  | String        | æ¯ä¸ªæ—¥å¿—æ–‡ä»¶çš„æœ€å¤§å ç”¨ç©ºé—´;<br>æ”¯æŒå•ä½: `KB| MB | GB`;<br> é»˜è®¤:`10MB`
log.rotation.count                 | Integer       | è½®æ¢çš„æœ€å¤§æ—¥å¿—æ–‡ä»¶æ•°;<br> é»˜è®¤: `5`

## SQLite é…ç½®å‚æ•°

| å‚æ•°å                     | æ•°æ®ç±»å‹ | å‚æ•°è¯´æ˜                                                     |
| -------------------------- | -------- | ------------------------------------------------------------ |
| sqlite.disk_cache_size     | Integer  | æœ€å¤§ç¼“å­˜æ¶ˆæ¯æ•°<br>*0 è¡¨ç¤ºä¸ç”Ÿæ•ˆ* <br>*1-infinity* <br>(*é»˜è®¤: `102400`*) |
| sqlite.mounted_file_path   | String   | æ•°æ®åº“æ–‡ä»¶å­˜å‚¨è·¯å¾„ (*é»˜è®¤åœ¨ nanomq è¿è¡Œè·¯å¾„ä¸‹*)                |
| sqlite.flush_mem_threshold | Integer  | å†…å­˜ç¼“å­˜æ¶ˆæ¯æ•°é˜ˆå€¼(è¾¾åˆ°é˜ˆå€¼åå†å†™å…¥ SQLITE è¡¨ä¸­) <br>*1-infinity*<br>(*é»˜è®¤: `100`*) |
| sqlite.resend_interval     | Integer  | æ•…éšœæ¢å¤åçš„é‡å‘æ—¶é—´é—´éš”ï¼ˆ ms ï¼‰ (*é»˜è®¤:` 5000`*)<br>æ³¨æ„:  **è¯¥å‚æ•°åªå¯¹ Broker æœ‰æ•ˆ** |



## æ ‡å‡† MQTT æ¡¥æ¥é…ç½®å‚æ•°

å‚æ•°å                                         | æ•°æ®ç±»å‹          | å‚æ•°è¯´æ˜
------------------------------------------- | ------------- | ----------------------------------------------
bridges.mqtt.name                           | String        | èŠ‚ç‚¹åå­—ã€‚
bridges.mqtt.name.server                    | String        | æ¡¥æ¥ç›®æ ‡ broker åœ°å€ URLã€‚ 
bridges.mqtt.name.proto_ver                 | Integer       | æ¡¥æ¥å®¢æˆ·ç«¯ MQTT ç‰ˆæœ¬ï¼ˆ 4 ï½œ 5 ï¼‰ã€‚
bridges.mqtt.name.clientid                  | String        | æ¡¥æ¥å®¢æˆ·ç«¯ ID ï¼ˆ_é»˜è®¤ NULL ä¸ºè‡ªåŠ¨ç”Ÿæˆéšæœº ID_ï¼‰ã€‚
bridges.mqtt.name.keepalive                 | Duration      | ä¿æ´»é—´éš”æ—¶é—´ã€‚
bridges.mqtt.name.clean_start               | Boolean       | æ¸…é™¤ä¼šè¯ã€‚
bridges.mqtt.name.username                  | String        | ç™»å½•ç”¨æˆ·åã€‚
bridges.mqtt.name.password                  | String        | ç™»å½•å¯†ç ã€‚
bridges.mqtt.name.conn_properties           | Object        | Connector çš„ MQTT V5 å±æ€§(è§ä¸‹è¡¨) 
bridges.mqtt.name.ssl.key_password          | String        | TLS ç§é’¥å¯†ç ã€‚                                                
bridges.mqtt.name.ssl.keyfile               | String        | TLS ç§é’¥æ•°æ®ã€‚                                                
bridges.mqtt.name.ssl.certfile              | String        | TLS Cert è¯ä¹¦æ•°æ®ã€‚                                           
bridges.mqtt.name.ssl.cacertfile            | String        | TLS CA è¯ä¹¦æ•°æ®ã€‚ 
bridges.mqtt.name.hybrid_bridging           | Boolean       | æ··åˆæ¡¥æ¥æ¨¡å¼å¼€å…³ï¼Œ(_é»˜è®¤ `false` ä¸å¯ç”¨_), å¦‚æœæƒ³æœ€å¤§åˆ©ç”¨ QUIC ï¼Œå»ºè®®å¯ç”¨ 
bridges.mqtt.name.quic_keepalive            | Duration      | Quic ä¼ è¾“å±‚ä¿æ´»æ—¶é—´, ï¼ˆ_é»˜è®¤ `120s`_ ) 
bridges.mqtt.name.quic_idle_timeout         | Duration      | Quic è¿æ¥æœ€å¤§è¿‡æœŸæ—¶é—´ ï¼ˆ_é»˜è®¤ `120s`_ ) 
bridges.mqtt.name.quic_discon_timeout       | Duration      | Quic ç­‰å¾…è¿æ¥ ACK æœ€å¤§æ—¶é—´ ï¼ˆ_é»˜è®¤ `20s`_ ) 
bridges.mqtt.name.quic_handshake_timeout    | Duration      | QUIC æ¡æ‰‹æœ€å¤§è¶…æ—¶æ—¶é—´ï¼ˆ_é»˜è®¤ `60s`_ ) 
bridges.mqtt.name.quic_send_idle_timeout    | Duration      | QUIC ä¼ è¾“å±‚é‡ç½®æ‹¥å¡æ§åˆ¶ç®—æ³•çš„ç­‰å¾…è¶…æ—¶æ—¶é—´ (*é»˜è®¤`60 s`*) 
bridges.mqtt.name.quic_initial_rtt_ms       | Duration      | åˆå§‹ RTT ä¼°è®¡æ—¶é—´ (*é»˜è®¤ `800ms`*) 
bridges.mqtt.name.quic_max_ack_delay_ms     | Duration      | å‘é€ ACK ä¹‹å‰æ¥æ”¶æ•°æ®åç­‰å¾…æ—¶é•¿(é»˜è®¤`100ms`) 
bridges.mqtt.name.quic_qos_priority         | Boolean       | é«˜ä¼˜å…ˆçº§å‘é€ QOS 1 æˆ– 2 çš„æ¶ˆæ¯(*é»˜è®¤ `true`*)                    
bridges.mqtt.name.quic_0rtt                 | Boolean       | 0RTT æ˜¯ QUIC åè®®çš„ä¸€ä¸ªç‰¹æ€§ï¼Œç”¨äºå¿«é€Ÿé‡æ–°å»ºç«‹è¿æ¥ (*é»˜è®¤ `true`*) 
bridges.mqtt.name.quic_multi_stream         | Boolean       | Quic Multiple stream å¼€å…³ï¼ˆ_é»˜è®¤`false`ä¸å¯ç”¨_ï¼‰             
bridges.mqtt.name.max_parallel_processes    | Long          | æ¡¥æ¥å®¢æˆ·ç«¯å¹¶å‘æ•°ã€‚
bridges.mqtt.name.forwards                  | Array[String] | è½¬å‘ Topic æ•°ç»„,
bridges.mqtt.name.subscription[0].topic     | String        | ç¬¬ 1 ä¸ªè®¢é˜…`Topic`ã€‚
bridges.mqtt.name.subscription[0].qos       | Integer       | ç¬¬ 1 ä¸ªè®¢é˜…`Qos`ã€‚
bridges.mqtt.name.sub_properties            | Object        | Subscription çš„ MQTT V5 å±æ€§(è§ä¸‹è¡¨) 
bridges.mqtt.name.max_send_queue_len        | Integer       | æœ€å¤§å‘é€é˜Ÿåˆ—é•¿åº¦ 
bridges.mqtt.name.max_recv_queue_len        | Integer       | æœ€å¤§æ¥æ”¶é˜Ÿåˆ—é•¿åº¦ 
bridges.mqtt.cache                          | Object        | æ¡¥æ¥å®¢æˆ·ç«¯ SQLITE é…ç½®ï¼Œè¯¦æƒ…è§[Sqlite é…ç½®å‚æ•°](#Sqlite é…ç½®å‚æ•°) 

### MQTT V5 å±æ€§é…ç½®å‚æ•°

`Connector`å±æ€§:`bridges.mqtt.nodes[0].connector.conn_properties`

| å‚æ•°å                      | æ•°æ®ç±»å‹            | å‚æ•°è¯´æ˜                                      |
| --------------------------- | ------------------- | --------------------------------------------- |
| maximum_packet_size         | Integer             | *æœ€å¤§æŠ¥æ–‡é•¿åº¦<br>* *Value: 1 ~ 4294967295*    |
| receive_maximum             | Integer             | *æ¥æ”¶æœ€å¤§æ•°é‡*<br>*Value: 1 ~ 65535*          |
| topic_alias_maximum         | Integer             | *ä¸»é¢˜åˆ«åæœ€å¤§é•¿åº¦*<br>*Value: 0 ~ 65535*      |
| request_problem_infomation  | Integer             | *è¯·æ±‚é—®é¢˜ä¿¡æ¯*<br>Default: 1<br>Value: 0 \| 1 |
| request_response_infomation | Integer             | *è¯·æ±‚å“åº”ä¿¡æ¯*<br>Default: 0<br>Value: 0 \| 1 |
| session_expiry_interval     | Integer             | *ä¼šè¯è¿‡æœŸé—´éš”*<br>*Value: 0 ~ 4294967295*     |
| user_property               | Map[String, String] | ç”¨æˆ·å±æ€§ Map[key(String) - value(String)]*     |

`Subscription`å±æ€§: `bridges.mqtt.nodes[0].sub_properties`

| å‚æ•°å        | æ•°æ®ç±»å‹            | å‚æ•°è¯´æ˜                                                |
| ------------- | ------------------- | ------------------------------------------------------- |
| identifier    | Integer             | *è®¢é˜…æ ‡è¯†ç¬¦*<br>*Value: 1 ~ 268,435,455*                |
| user_property | Map[String, String] | *ç”¨æˆ·å±æ€§*<br>*Value: Map[key(String) - value(String)]* |

**ğŸ“¢æ³¨æ„**ï¼šNanoMQ æ”¯æŒé€šè¿‡é…ç½®æ–‡ä»¶ `nanomq.conf` æ¥é…ç½®å¤šä¸ªæ¡¥æ¥ï¼Œæ‚¨å¯é€šè¿‡ä¸åŒçš„åç§°æ¥åŒºåˆ†å¤šä¸ªæ¡¥æ¥ã€‚æ­¤å¤–ï¼Œ`cache` ç›¸å…³é…ç½®é¡¹ä½œä¸ºä¸€ä¸ªç‹¬ç«‹çš„ç»„ä»¶å·¥ä½œï¼Œæ”¯æŒè¢«å¤šä¸ªç»„ä»¶å¼•ç”¨ã€‚ä¾‹å¦‚ï¼Œæ‚¨éœ€è¦åœ¨å¤šä¸ªæ¡¥æ¥ä¸­å®ç°æ¶ˆæ¯ç¼“å­˜ï¼Œå¯æŒ‰ç…§å¦‚ä¸‹ç¤ºä¾‹è¿›è¡Œé…ç½®ã€‚

```shell
## ç¬¬ä¸€ä¸ªæ¡¥æ¥å®¢æˆ·ç«¯
bridges.mqtt.emqx1 {
  ......
}

## ç¬¬äºŒä¸ªæ¡¥æ¥å®¢æˆ·ç«¯
bridges.mqtt.emqx2 {
  ......
}

## å¦‚æœéœ€è¦ç¼“å­˜æ¡¥æ¥æ¶ˆæ¯ï¼ŒåŠ ä¸Š cache çš„é…ç½®
bridges.mqtt.cache  {
  ......
}
````



## Aws IoT Core MQTT æ¡¥æ¥é…ç½®å‚æ•°

å‚æ•°å                                       | æ•°æ®ç±»å‹          | å‚æ•°è¯´æ˜
----------------------------------------- | ------------- | --------------------------------
bridge.aws.name.server                    | String        | AWS IoT Core åœ°å€ URL (_IP:PORT_)ã€‚
bridge.aws.name.proto_ver                 | Integer       | æ¡¥æ¥å®¢æˆ·ç«¯ MQTT ç‰ˆæœ¬ï¼ˆ 4 ï½œ 5 ï¼‰ã€‚
bridge.aws.name.clientid                  | String        | æ¡¥æ¥å®¢æˆ·ç«¯ ID ï¼ˆ_é»˜è®¤ NULL ä¸ºè‡ªåŠ¨ç”Ÿæˆéšæœº ID_ï¼‰ã€‚
bridge.aws.name.keepalive                 | Duration      | ä¿æ´»é—´éš”æ—¶é—´ã€‚
bridge.aws.name.clean_start               | Boolean       | æ¸…é™¤ä¼šè¯ã€‚
bridge.aws.name.username                  | String        | ç™»å½•ç”¨æˆ·åã€‚
bridge.aws.name.password                  | String        | ç™»å½•å¯†ç ã€‚
bridge.aws.name.ssl.key_password          | String        | TLS ç§é’¥å¯†ç ã€‚
bridge.aws.name.ssl.keyfile               | String        | TLS ç§é’¥æ•°æ®ã€‚
bridge.aws.name.ssl.certfile              | String        | TLS Cert è¯ä¹¦æ•°æ®ã€‚
bridge.aws.name.ssl.cacertfile            | String        | TLS CA è¯ä¹¦æ•°æ®ã€‚
bridge.aws.name.max_parallel_processes    | Long          | æ¡¥æ¥å®¢æˆ·ç«¯å¹¶å‘æ•°ã€‚
bridge.aws.name.forwards                  | Array[String] | è½¬å‘ Topic æ•°ç»„
bridge.aws.name.subscription[0].topic     | String        | ç¬¬ 1 ä¸ªè®¢é˜…`Topic`ã€‚
bridge.aws.name.subscription[0].qos       | Integer       | ç¬¬ 1 ä¸ªè®¢é˜…`Qos`ã€‚

å¯ç”¨ AWS æ¡¥æ¥å¦‚ä¸‹ï¼ŒAWS è¯¦ç»†æ¡¥æ¥é…ç½®å¯å‚è€ƒ `nanomq_example.conf` å†…äº‹ä¾‹ã€‚

```shell
## AWS æ¡¥æ¥å®¢æˆ·ç«¯äº‹ä¾‹
bridges.aws.c1 {
  ......
}

````



## WebHook é…ç½®

| å‚æ•°å                                    | æ•°æ®ç±»å‹ | å‚æ•°è¯´æ˜                                                    |
| ---------------------------------------- | ------- | ------------------------------------------------------------ |
| webhook.url                             | String  | *Webhook URL*                                                |
| webhook.headers.\<Any\>                 | String  | *HTTP Headers*<br>*Example:*<br>*1. webhook.headers.content-type=application/json*<br> *2. webhook.headers.accept=\** |
| webhook.body.encoding                   | String  | *Payload ç¼–ç æ–¹å¼*<br>Options: <br>`plain` \| `base64` \| `base62`  |
| webhook.pool_size                       | Integer | *è¿æ¥æ± å¤§å° ï¼ˆé»˜è®¤: 32 ï¼‰*.                                   |
| webhook.events[0].event                 | String  | äº‹ä»¶ç±»å‹ï¼Œç›®å‰æ”¯æŒä¸‰ç§äº‹ä»¶ï¼š  <br> `on_client_connack` <br> `on_client_disconnected` <br> `on_message_publish`  <br> |
| webhook.events[0].topic                 | String  | å½“äº‹ä»¶ç±»å‹ä¸º `on_message_publish` æ—¶, æ”¯æŒ topic çš„è®¾ç½® |

## æˆæƒé…ç½®

æˆæƒé…ç½®ç»“æ„å¤§è‡´å¦‚ä¸‹ã€‚

```bash
auth {
  allow_anonymous = true
  no_match = allow
  deny_action = ignore
  cache {
    max_size = 1024
    duration = 1m
  }
  password = {include "/etc/nanomq_pwd.conf"}
  acl = {include "/etc/nanomq_acl.conf"}
}
```

æ¯ä¸ª Authorizer çš„è¯¦ç»†é…ç½®ï¼Œå¯ä»¥å‚è€ƒç›¸åº”çš„é…ç½®æ–‡ä»¶æ–‡æ¡£ã€‚

`allow_anonymous`

æ•°æ®ç±»å‹ä¸º `boolean`, ç¼ºçœå€¼ä¸º `true`ï¼Œå³å…è®¸åŒ¿åç™»å½•ã€‚

`no_match`

å¯é€‰å€¼ï¼Œå¯ä»¥è®¾ç½®ä¸º `allow` æˆ– `deny`ã€‚ç¼ºçœå€¼æ˜¯ `allow`ã€‚ å½“ EMQX æ— æ³•ä»è®¤è¯é“¾ä¸­ä¸ºæŸä¸ªå®¢æˆ·ç«¯åŒ¹é…åˆ°ä»»ä½•è§„åˆ™æ—¶å€™ï¼Œå°†ä¼šä½¿ç”¨è¿™ä¸ªé»˜è®¤çš„è§„åˆ™ã€‚

`deny_action`

å¯é€‰å€¼ï¼Œå¯ä»¥è®¾ç½®ä¸º `ignore` æˆ– `disconnect`ã€‚é»˜è®¤å€¼æ˜¯ `ignore`ã€‚ è¿™ä¸ªé…ç½®ç”¨äºæŒ‡å®šå½“æ‹’ç»è®¿é—®å‘ç”Ÿæ—¶ï¼Œåº”è¯¥å¦‚ä½•å¯¹å¾…è¿™ä¸ªå®¢æˆ·ç«¯çš„ MQTT è¿æ¥ã€‚ å¦‚æœé…ç½®æˆ `ignore`ï¼Œé‚£ä¹ˆè¿™ä¸ªæ“ä½œä¼šè¢«ä¸¢å¼ƒï¼Œä¾‹å¦‚ï¼Œå¦‚æœæ˜¯ä¸€ä¸ªå‘å¸ƒåŠ¨ä½œï¼Œé‚£ä¹ˆè¿™æ¶ˆæ¯ä¼šè¢«ä¸¢å¼ƒï¼›å¦‚æœæ˜¯ä¸€ä¸ªè®¢é˜…æ“ä½œï¼Œé‚£ä¹ˆè®¢é˜…è¯·æ±‚ä¼šè¢«æ‹’ç»ã€‚ å¦‚æœé…ç½®æˆ `disconnect`ï¼Œé‚£ä¹ˆè¿™ä¸ªå®¢æˆ·ç«¯å°†ä¼šè¢«æ–­å¼€è¿æ¥ã€‚

`cache`

ACL ç¼“å­˜çš„é…ç½®ã€‚

- `cache.max_size` â€” é»˜è®¤å€¼ `32`ã€‚æ­¤é…ç½®è§„å®šæ¯ä¸ªå®¢æˆ·ç«¯å…è®¸ç¼“å­˜çš„ ACL è§„åˆ™æ•°é‡ã€‚å½“è¶…è¿‡ä¸Šé™æ—¶ï¼Œè€çš„è®°å½•å°†ä¼šè¢«åˆ æ‰ã€‚
- `cache.ttl` â€” é»˜è®¤ `1m`ï¼ˆä¸€åˆ†é’Ÿï¼‰ã€‚ è¯¥é…ç½®è§„å®š ACL è§„åˆ™ç¼“å­˜æœ‰æ•ˆæ—¶é—´ã€‚

### ç”¨æˆ·ç™»é™†éªŒè¯

| å‚æ•°å   | æ•°æ®ç±»å‹ | å‚æ•°è¯´æ˜     |
| -------- | -------- | ------------ |
| username | String   | ç™»å½•ç”¨æˆ·åã€‚ |
| password | String   | ç™»å½•å¯†ç ã€‚   |

è¯·ä»¥ä»¥ä¸‹æ ¼å¼å°†ç”¨æˆ·åå’Œå¯†ç å†™å…¥ `nanomq_pwd.conf` æ–‡ä»¶ï¼š
```shell
username:password
```

ä¾‹å­ï¼š


```bash
# # Write "username":"password" in this way.
admin: public
client: public
```


### ACL æ–‡ä»¶éªŒè¯é…ç½®

ACL è§„åˆ™çš„åŒ¹é…éµå¾ªè‡ªé¡¶å‘ä¸‹çš„é¡ºåºã€‚å½“ä¸€ä¸ªè§„åˆ™åŒ¹é…åˆ°å½“å‰å®¢æˆ·ç«¯æ—¶ï¼Œè§„åˆ™å…è®¸æˆ–æ‹’ç»çš„åŠ¨ä½œå°±ä¼šç”Ÿæ•ˆï¼Œåé¢çš„è§„åˆ™ä¸å†ç»§ç»­æ£€æŸ¥ã€‚

| å­—æ®µå   | æ•°æ®ç±»å‹       | å¿…å¡« | æè¿°                                                            |
| -------- | -------------- | ---- | ----------------------------------------------------------- |
| permit   | enum           | æ˜¯   | è§„åˆ™æƒé™:å…è®¸ï¼š`allow`æ‹’ç»ï¼š`deny`                              |
| action   | enum           | å¦   | æŒ‡å®šåŠ¨ä½œ:å‘å¸ƒ: `publish`è®¢é˜…: `subscribe`ä»¥ä¸ŠäºŒè€…: `pubsub`      |
| topics   | Array[String]  | å¦   | ä¸»é¢˜æˆ–ä¸»é¢˜è¿‡æ»¤å™¨æ•°ç»„                                            |
| username | String         | å¦   | ç”¨æˆ·åè‹¥è¾“å…¥å€¼ä¸º"`#`"ï¼Œè¡¨ç¤ºæ‰€æœ‰ç”¨æˆ·                               |
| clientid | String         | å¦   | å®¢æˆ·ç«¯ ID è‹¥è¾“å…¥å€¼ä¸º"`#`"ï¼Œè¡¨ç¤ºæ‰€æœ‰å®¢æˆ·ç«¯                           |
| and      | Array[Map]     | å¦   | ä¸æ“ä½œ                                                       |
| or       | Array[Map]     | å¦   | æˆ–æ“ä½œ                                                       |

ä¾‹å­:

```bash
rules = [
  ## å…è®¸ç”¨æˆ·åä¸º"dashboard" çš„ MQTT å®¢æˆ·ç«¯é€šè¿‡è®¢é˜…"$SYS/#"ä¸»é¢˜
  {"permit": "allow", "username": "dashboard", "action": "subscribe", "topics": ["$SYS/#"]}

  ## å…è®¸ IP ä¸º "127.0.0.1" çš„ç”¨æˆ·è®¢é˜…"$SYS/#", "#"ä¸»é¢˜æˆ–å‘å…¶å‘é€æ¶ˆæ¯ã€‚
  {"permit": "allow", "ipaddr": "127.0.0.1", "action": "pubsub", "topics": ["$SYS/#", "#"]}

  ## æ‹’ç»"æ‰€æœ‰ç”¨æˆ·"è®¢é˜…"$SYS/#" "#"ä¸»é¢˜
  {"permit": "deny", "username": "#", "action": "subscribe", "topics": ["$SYS/#", "#"]}

  ## å…è®¸ä»»ä½•å…¶ä»–å‘å¸ƒ/è®¢é˜…æ“ä½œ
  {"permit": "allow"}
]
```


### HTTP èº«ä»½éªŒè¯

| å‚æ•°å                              | æ•°æ®ç±»å‹ | å‚æ•°è¯´æ˜                                                     | é»˜è®¤                                                         |
| ----------------------------------- | -------- | ------------------------------------------------------------ | ------------------------------------------------------------ |
| auth.http_auth.enable                    | Boolean  | å¯åŠ¨ HTTP è®¤è¯                                                 | `false`                                                      |
| auth.http_auth.auth_req.url              | String   | è®¤è¯è¯·æ±‚çš„ç›®æ ‡ URLã€‚                                         | `http://127.0.0.1:80/mqtt/auth`                              |
| auth.http_auth.auth_req.method           | String     | è®¤è¯è¯·æ±‚çš„è¯·æ±‚æ–¹æ³•ã€‚<br>(`POST`  , `GET`)                    | `POST`                                                       |
| auth.http_auth.auth_req.headers.\<Any\>  | String   | æŒ‡å®š HTTP è¯·æ±‚å¤´éƒ¨ä¸­çš„æ•°æ®ã€‚`<Key>` æŒ‡å®š HTTP è¯·æ±‚å¤´éƒ¨ä¸­çš„å­—æ®µåï¼Œæ­¤é…ç½®é¡¹çš„å€¼ä¸ºç›¸åº”çš„å­—æ®µå€¼ã€‚`<Key>` å¯ä»¥æ˜¯æ ‡å‡†çš„ HTTP è¯·æ±‚å¤´éƒ¨å­—æ®µï¼Œä¹Ÿå¯ä»¥è‡ªå®šä¹‰çš„å­—æ®µï¼Œå¯ä»¥é…ç½®å¤šä¸ªä¸åŒçš„è¯·æ±‚å¤´éƒ¨å­—æ®µã€‚<br> | `auth.http_auth.auth_req.headers.content-type = application/x-www-form-urlencoded` <br/>`auth.http_auth.auth_req.headers.accept = */*` |
| auth.http_auth.auth_req.params        | Array[Object]  | æŒ‡å®šè®¤è¯è¯·æ±‚ä¸­æºå¸¦çš„æ•°æ®ã€‚<br>ä»¥ `,` åˆ†éš”çš„ `k=v` é”®å€¼å¯¹ï¼Œ`v` å¯ä»¥æ˜¯å›ºå®šå†…å®¹ï¼Œä¹Ÿå¯ä»¥æ˜¯å ä½ç¬¦ã€‚<br> ä½¿ç”¨ **GET** æ–¹æ³•æ—¶ `auth.http_auth.auth_req.params` çš„å€¼å°†è¢«è½¬æ¢ä¸ºä»¥ `&` åˆ†éš”çš„ `k=v` é”®å€¼å¯¹ä»¥æŸ¥è¯¢å­—ç¬¦ä¸²å‚æ•°çš„å½¢å¼å‘é€ã€‚<br>ä½¿ç”¨ **POST** æ–¹æ³•æ—¶ `auth.http_auth.auth_req.params` çš„å€¼å°†è¢«è½¬æ¢ä¸ºä»¥ `&` åˆ†éš”çš„ `k=v` é”®å€¼å¯¹ä»¥ Request Body çš„å½¢å¼å‘é€ã€‚æ‰€æœ‰çš„å ä½ç¬¦éƒ½ä¼šè¢«è¿è¡Œæ—¶æ•°æ®æ‰€æ›¿æ¢ï¼Œå¯ç”¨çš„å ä½ç¬¦å¦‚ä¸‹ï¼š<br>`%u: ç”¨æˆ·å`<br>`%c: MQTT Client ID`<br>`%a: å®¢æˆ·ç«¯çš„ç½‘ç»œ IP åœ°å€`<br>`%r: å®¢æˆ·ç«¯ä½¿ç”¨çš„åè®®ï¼Œå¯ä»¥æ˜¯ï¼š mqtt, mqtt-sn, coap, lwm2m ä»¥åŠ stomp`<br>`%P: å¯†ç `<br>`%p: å®¢æˆ·ç«¯è¿æ¥çš„æœåŠ¡ç«¯ç«¯å£`<br>`%C: å®¢æˆ·ç«¯è¯ä¹¦ä¸­çš„ Common Name`<br>`%d: å®¢æˆ·ç«¯è¯ä¹¦ä¸­çš„ Subject` | `auth.http_auth.auth_req.params = {clientid= "%c", username= "%u", password= "%P"}`                        |
| auth.http_auth.super_req.url             | String   | æŒ‡å®šè¶…çº§ç”¨æˆ·è®¤è¯è¯·æ±‚çš„ç›®æ ‡ URLã€‚                             | `http://127.0.0.1:80/mqtt/superuser`                         |
| auth.http_auth.super_req.method          | String   | æŒ‡å®šè¶…çº§ç”¨æˆ·è®¤è¯è¯·æ±‚çš„è¯·æ±‚æ–¹æ³•ã€‚<br>(`POST`  , `GET`)        | `POST`                                                       |
| auth.http_auth.super_req.headers.\<Any\> | String   | æŒ‡å®š HTTP è¯·æ±‚å¤´éƒ¨ä¸­çš„æ•°æ®ã€‚`<Key>` æŒ‡å®š HTTP è¯·æ±‚å¤´éƒ¨ä¸­çš„å­—æ®µåï¼Œæ­¤é…ç½®é¡¹çš„å€¼ä¸ºç›¸åº”çš„å­—æ®µå€¼ã€‚`<Key>` å¯ä»¥æ˜¯æ ‡å‡†çš„ HTTP è¯·æ±‚å¤´éƒ¨å­—æ®µï¼Œä¹Ÿå¯ä»¥è‡ªå®šä¹‰çš„å­—æ®µï¼Œå¯ä»¥é…ç½®å¤šä¸ªä¸åŒçš„è¯·æ±‚å¤´éƒ¨å­—æ®µã€‚ | `auth.http_auth.super_req.headers.content-type = application/x-www-form-urlencoded`<br/>`auth.http_auth.super_req.headers.accept = */*` |
| auth.http_auth.super_req.params          |Array[Object]    | æŒ‡å®šè¶…çº§ç”¨æˆ·è®¤è¯è¯·æ±‚ä¸­æºå¸¦çš„æ•°æ®ã€‚<br>ä½¿ç”¨ **GET** æ–¹æ³•æ—¶ `auth.http_auth.super_req.params` çš„å€¼å°†è¢«è½¬æ¢ä¸ºä»¥ `&` åˆ†éš”çš„ `k=v` é”®å€¼å¯¹ä»¥æŸ¥è¯¢å­—ç¬¦ä¸²å‚æ•°çš„å½¢å¼å‘é€ã€‚<br>ä½¿ç”¨ **POST** æ–¹æ³•æ—¶ `auth.http_auth.super_req.params` çš„å€¼å°†è¢«è½¬æ¢ä¸ºä»¥ `&` åˆ†éš”çš„ `k=v` é”®å€¼å¯¹ä»¥ Request Body çš„å½¢å¼å‘é€ã€‚æ‰€æœ‰çš„å ä½ç¬¦éƒ½ä¼šè¢«è¿è¡Œæ—¶æ•°æ®æ‰€æ›¿æ¢ï¼Œå¯ç”¨çš„å ä½ç¬¦åŒ `auth.http_auth.auth_req.params`ã€‚ | `auth.http_auth.super_req.params = {clientid= "%c", username= "%u", password= "%P"}`                                    |
| auth.http_auth.acl_req.url               | String   | æŒ‡å®š ACL éªŒè¯è¯·æ±‚çš„ç›®æ ‡ URLã€‚                                | `http://127.0.0.1:8991/mqtt/acl`                             |
| auth.http_auth.acl_req.method            | String   | æŒ‡å®š ACL éªŒè¯è¯·æ±‚çš„è¯·æ±‚æ–¹æ³•ã€‚(`POST`  , `GET`)               | `POST`                                                       |
| auth.http_auth.acl_req.headers.\<Any\>   | String   | æŒ‡å®š HTTP è¯·æ±‚å¤´éƒ¨ä¸­çš„æ•°æ®ã€‚`<Key>` æŒ‡å®š HTTP è¯·æ±‚å¤´éƒ¨ä¸­çš„å­—æ®µåï¼Œæ­¤é…ç½®é¡¹çš„å€¼ä¸ºç›¸åº”çš„å­—æ®µå€¼ã€‚`<Key>` å¯ä»¥æ˜¯æ ‡å‡†çš„ HTTP è¯·æ±‚å¤´éƒ¨å­—æ®µï¼Œä¹Ÿå¯ä»¥è‡ªå®šä¹‰çš„å­—æ®µï¼Œå¯ä»¥é…ç½®å¤šä¸ªä¸åŒçš„è¯·æ±‚å¤´éƒ¨å­—æ®µã€‚ | `auth.http_auth.super_req.headers.content-type = application/x-www-form-urlencoded`<br/>`auth.http_auth.super_req.headers.accept = */*` |
| auth.http_auth.acl_req.params            | Array[Object]   | æŒ‡å®š ACL éªŒè¯è¯·æ±‚ä¸­æºå¸¦çš„æ•°æ®ã€‚ä»¥ `,` åˆ†éš”çš„ `k=v` é”®å€¼å¯¹ï¼Œ`v` å¯ä»¥æ˜¯å›ºå®šå†…å®¹ï¼Œä¹Ÿå¯ä»¥æ˜¯å ä½ç¬¦ã€‚<br/> ä½¿ç”¨ **GET** æ–¹æ³•æ—¶ `auth.http_auth.acl_req.params` çš„å€¼å°†è¢«è½¬æ¢ä¸ºä»¥ `&` åˆ†éš”çš„ `k=v` é”®å€¼å¯¹ä»¥æŸ¥è¯¢å­—ç¬¦ä¸²å‚æ•°çš„å½¢å¼å‘é€ã€‚<br/>ä½¿ç”¨ **POST** æ–¹æ³•æ—¶ `auth.http_auth.acl_req.params` çš„å€¼å°†è¢«è½¬æ¢ä¸ºä»¥ `&` åˆ†éš”çš„ `k=v` é”®å€¼å¯¹ä»¥ Request Body çš„å½¢å¼å‘é€ã€‚æ‰€æœ‰çš„å ä½ç¬¦éƒ½ä¼šè¢«è¿è¡Œæ—¶æ•°æ®æ‰€æ›¿æ¢ï¼Œå¯ç”¨çš„å ä½ç¬¦å¦‚ä¸‹ï¼š<br/>`%A: éœ€è¦éªŒè¯çš„æƒé™ï¼Œ 1 è¡¨ç¤ºè®¢é˜…ï¼Œ 2 è¡¨ç¤ºå‘å¸ƒ`<br>`%u: ç”¨æˆ·å`<br/>`%c: MQTT Client ID`<br/>`%a: å®¢æˆ·ç«¯çš„ç½‘ç»œ IP åœ°å€`<br/>`%r: å®¢æˆ·ç«¯ä½¿ç”¨çš„åè®®ï¼Œå¯ä»¥æ˜¯ï¼š mqtt, mqtt-sn, coap, lwm2m ä»¥åŠ stomp`<br/>`%m: æŒ‚è½½ç‚¹`<br>`%t: ä¸»é¢˜` | `auth.http_auth.acl_req.params = {clientid = "%c", username = "%u", access = "%A", ipaddr = "%a", topic = "%t", mountpoint = "%m"}` |
| auth.http_auth.timeout                   | Integer  | HTTP è¯·æ±‚è¶…æ—¶æ—¶é—´ã€‚ä»»ä½•ç­‰ä»·äº `0s` çš„è®¾å®šå€¼éƒ½è¡¨ç¤ºæ°¸ä¸è¶…æ—¶ã€‚  | `5s`                                                         |
| auth.http_auth.connect_timeout           | Integer  | HTTP è¯·æ±‚çš„è¿æ¥è¶…æ—¶æ—¶é—´ã€‚ä»»ä½•ç­‰ä»·äº `0s` çš„è®¾å®šå€¼éƒ½è¡¨ç¤ºæ°¸ä¸è¶…æ—¶ã€‚ | `5s`                                                         |

ä¾‹å­:

```bash
http_auth = {
  auth_req {
    url = "http://127.0.0.1:80/mqtt/auth"
    method = "POST"
    headers.content-type = "application/x-www-form-urlencoded"
    params = {clientid = "%c", username = "%u", password = "%p"}
  }

  super_req {
    url = "http://127.0.0.1:80/mqtt/superuser"
    method = "POST"
    headers.content-type = "application/x-www-form-urlencoded"
    params = {clientid = "%c", username = "%u", password = "%p"}
  }

  acl_req {
    url = "http://127.0.0.1:8991/mqtt/acl"
    method = "POST"
    headers.content-type = "application/x-www-form-urlencoded"
    params = {clientid = "%c", username = "%u", access = "%A", ipaddr = "%a", topic = "%t", mountpoint = "%m"}
  }

  timeout = 5s
  connect_timeout = 5s
  pool_size = 32
}
```



## è§„åˆ™å¼•æ“é…ç½®

### SQLite è§„åˆ™é…ç½®

å‚æ•°å                          | æ•°æ®ç±»å‹   | å‚æ•°è¯´æ˜
------------------------------ | ------    | -------------------------------------------
rules.sqlite.path              | String    | è§„åˆ™å¼•æ“ SQLite3 æ•°æ®åº“è·¯å¾„, é»˜è®¤æ˜¯ /tmp/rules_engine.db
rules.sqlite.rules[0].table    | String    | è§„åˆ™å¼•æ“ SQLite3 æ•°æ®åº“è¡¨å
rules.sqlite.rules[0].sql      | String    | è§„åˆ™å¼•æ“ sql è¯­å¥


### MySQL è§„åˆ™é…ç½®

å‚æ•°å                              | æ•°æ®ç±»å‹   | å‚æ•°è¯´æ˜
---------------------------------- | -------- | -----------------------------------
rules.mysql.name.conn.table        | String   | è§„åˆ™å¼•æ“ mysql æ•°æ®åº“è¡¨åå­—
rules.mysql.name.conn.host         | String   | è§„åˆ™å¼•æ“ mysql æ•°æ®åº“ä¸»æœºå
rules.mysql.name.conn.username     | String   | è§„åˆ™å¼•æ“ mysql æ•°æ®åº“ç”¨æˆ·
rules.mysql.name.conn.password     | String   | è§„åˆ™å¼•æ“ mysql æ•°æ®åº“å¯†
rules.mysql.name.rules[0].table    | String   | è§„åˆ™å¼•æ“ mysql æ•°æ®åº“åå­—, é»˜è®¤æ˜¯ mysql_rules_db
rules.mysql.name.rules[0].sql      | String   | è§„åˆ™å¼•æ“ sql è¯­å¥



### Repub è§„åˆ™é…ç½®

å‚æ•°å                             | æ•°æ®ç±»å‹     | å‚æ•°è¯´æ˜
--------------------------------- | -------- | ---------------------------------
rules.repub.rules[0].address      | String   | è§„åˆ™å¼•æ“é‡æ–°å‘å¸ƒåœ°å€ (mqtt-tcp://host:port)
rules.repub.rules[0].topic        | String   | è§„åˆ™å¼•æ“é‡æ–°å‘å¸ƒä¸»é¢˜
rules.repub.rules[0].username     | String   | è§„åˆ™å¼•æ“é‡æ–°å‘å¸ƒç”¨æˆ·å
rules.repub.rules[0].password     | String   | è§„åˆ™å¼•æ“é‡æ–°å‘å¸ƒå¯†ç 
rules.repub.rules[0].proto_ver    | Integer  | è§„åˆ™å¼•æ“é‡æ–°å‘å¸ƒåè®®ç‰ˆæœ¬, é»˜è®¤æ˜¯ 4
rules.repub.rules[0].clientid     | String   | è§„åˆ™å¼•æ“é‡æ–°å‘å¸ƒå®¢æˆ·ç«¯æ ‡è¯†ç¬¦
rules.repub.rules[0].keepalive    | Duration | è§„åˆ™å¼•æ“é‡æ–°å‘å¸ƒä¿æ´»æ—¶é—´, é»˜è®¤å€¼æ˜¯ 60
rules.repub.rules[0].clean_start  | Boolean  | è§„åˆ™å¼•æ“é‡æ–°å‘å¸ƒ clean_start æ ‡å¿—, é»˜è®¤æ˜¯ true
rules.repub.rules[0].sql          | String   | è§„åˆ™å¼•æ“ sql è¯­å¥

