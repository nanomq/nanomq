name: ClusterFuzzLite Continuous Fuzzing

on:
  # Run on pull requests for PR fuzzing
  pull_request:
    branches: [master, main]  # 支持 master 和 main 分支
    paths:
      - 'nanomq/**'
      - 'nng/**'
      - 'fuzz/**'
      - '.clusterfuzzlite/**'
      - 'build.sh'

  # Run on pushes to main for batch fuzzing
  push:
    branches: [master, main]
    paths:
      - 'nanomq/**'
      - 'nng/**'
      - 'fuzz/**'
      - '.clusterfuzzlite/**'
      - 'build.sh'

  # Allow manual triggering
  workflow_dispatch:

  # Run on a schedule for continuous fuzzing
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'

permissions:
  contents: read
  issues: write
  pull-requests: write
  security-events: write
  actions: write  # 添加此权限以上传 artifacts

jobs:
  # PR fuzzing - quick checks on pull requests
  pr-fuzzing:
    name: PR Fuzzing
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    concurrency:
      group: ${{ github.workflow }}-${{ matrix.sanitizer }}-${{ github.ref }}
      cancel-in-progress: true
    strategy:
      fail-fast: false
      matrix:
        sanitizer:
          - address
          # - undefined
    steps:
      - name: Build Fuzzers (${{ matrix.sanitizer }})
        id: build
        uses: google/clusterfuzzlite/actions/build_fuzzers@v1
        with:
          language: c  # NanoMQ 是 C 项目
          github-token: ${{ secrets.GITHUB_TOKEN }}
          sanitizer: ${{ matrix.sanitizer }}
          # 如果需要使用 storage repo 来存储 corpus
          # storage-repo: https://${{ secrets.PERSONAL_ACCESS_TOKEN }}@github.com/OWNER/STORAGE-REPO-NAME.git
          # storage-repo-branch: main

      - name: Run Fuzzers (${{ matrix.sanitizer }})
        id: run
        uses: google/clusterfuzzlite/actions/run_fuzzers@v1
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          fuzz-seconds: 300  # 5 minutes per target for PR
          mode: 'code-change'
          sanitizer: ${{ matrix.sanitizer }}
          output-sarif: true
          # storage-repo: https://${{ secrets.PERSONAL_ACCESS_TOKEN }}@github.com/OWNER/STORAGE-REPO-NAME.git

      - name: Upload SARIF
        if: always() && steps.run.outcome == 'failure'
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: ${{ steps.run.outputs.sarif }}

      # 上传 corpus 作为 artifact（可选，用于调试）
      - name: Upload Corpus
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: corpus-pr-${{ matrix.sanitizer }}
          path: build-out/corpus
          retention-days: 7

  # Batch fuzzing - longer runs on main branch
  batch-fuzzing:
    name: Batch Fuzzing
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    concurrency:
      group: ${{ github.workflow }}-batch-${{ matrix.sanitizer }}
      cancel-in-progress: true
    strategy:
      fail-fast: false
      matrix:
        sanitizer:
          - address
          # - undefined
    steps:
      - name: Build Fuzzers (${{ matrix.sanitizer }})
        id: build
        uses: google/clusterfuzzlite/actions/build_fuzzers@v1
        with:
          language: c
          github-token: ${{ secrets.GITHUB_TOKEN }}
          sanitizer: ${{ matrix.sanitizer }}

      - name: Run Fuzzers (${{ matrix.sanitizer }})
        id: run
        uses: google/clusterfuzzlite/actions/run_fuzzers@v1
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          fuzz-seconds: 600  # 10 minutes per target
          mode: 'batch'
          sanitizer: ${{ matrix.sanitizer }}
          output-sarif: true

      - name: Upload SARIF
        if: always() && steps.run.outcome == 'failure'
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: ${{ steps.run.outputs.sarif }}

      # 上传 corpus
      - name: Upload Corpus
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: corpus-batch-${{ matrix.sanitizer }}
          path: build-out/corpus
          retention-days: 90

  # Continuous fuzzing - long runs on schedule
  continuous-fuzzing:
    name: Continuous Fuzzing
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    concurrency:
      group: ${{ github.workflow }}-continuous-${{ matrix.sanitizer }}
      cancel-in-progress: false
    strategy:
      fail-fast: false
      matrix:
        sanitizer:
          - address
          # - undefined
          # - memory
    steps:
      - name: Build Fuzzers (${{ matrix.sanitizer }})
        id: build
        uses: google/clusterfuzzlite/actions/build_fuzzers@v1
        with:
          language: c
          github-token: ${{ secrets.GITHUB_TOKEN }}
          sanitizer: ${{ matrix.sanitizer }}

      - name: Run Fuzzers (${{ matrix.sanitizer }})
        id: run
        uses: google/clusterfuzzlite/actions/run_fuzzers@v1
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          fuzz-seconds: 3600  # 1 hour per target
          mode: 'batch'
          sanitizer: ${{ matrix.sanitizer }}
          output-sarif: true

      - name: Upload SARIF
        if: always() && steps.run.outcome == 'failure'
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: ${{ steps.run.outputs.sarif }}

      # 上传发现的 crashes
      - name: Upload Crashes
        if: always() && steps.run.outcome == 'failure'
        uses: actions/upload-artifact@v4
        with:
          name: crashes-${{ matrix.sanitizer }}
          path: build-out/artifacts
          retention-days: 90

  # Corpus pruning - minimize corpus size
  prune:
    name: Prune Corpus
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'
    concurrency:
      group: ${{ github.workflow }}-prune
      cancel-in-progress: false
    steps:
      - name: Build Fuzzers
        id: build
        uses: google/clusterfuzzlite/actions/build_fuzzers@v1
        with:
          language: c
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Run Fuzzers (Prune)
        id: run
        uses: google/clusterfuzzlite/actions/run_fuzzers@v1
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          fuzz-seconds: 600
          mode: 'prune'

      - name: Upload Pruned Corpus
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: corpus-pruned
          path: build-out/corpus
          retention-days: 90

  # Coverage report - 生成并上传 coverage
  coverage:
    name: Code Coverage
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    concurrency:
      group: ${{ github.workflow }}-coverage
      cancel-in-progress: true
    steps:
      - name: Build Fuzzers (Coverage)
        id: build
        uses: google/clusterfuzzlite/actions/build_fuzzers@v1
        with:
          language: c
          github-token: ${{ secrets.GITHUB_TOKEN }}
          sanitizer: coverage

      - name: Run Fuzzers (Coverage)
        id: run
        uses: google/clusterfuzzlite/actions/run_fuzzers@v1
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          fuzz-seconds: 600
          mode: 'coverage'

      # 上传 coverage report 作为 artifact
      - name: Upload Coverage Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: cifuzz-coverage-latest
          path: build-out/report
          retention-days: 90

      # 可选：上传 coverage 到 Codecov
      # - name: Upload to Codecov
      #   if: always()
      #   uses: codecov/codecov-action@v4
      #   with:
      #     files: build-out/report/linux/summary.json
      #     flags: fuzzing
      #     name: fuzzing-coverage